<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.kh.woofly.board.model.dao.BoardDAO">
	 
	<!-- 자유게시판 -->	
	<select id="getListCount" resultType="_int">
		select count(*)
		from board
		where b_status = 'Y'
	</select>

	<select id="selectBoardList" resultType="Board">
		select *
		from board
		join member using (mb_id)
		where b_status = 'Y' 
		order by b_no desc
	</select>


	<!-- 수정될거임 1. null을 보내면 전체사진, 2. 보드아이디와 보드타입을 보내면? 전체 사진 중에서 해당 게시판의 해당게시글의 사진들 
			and attm_ref_no = #{bId}-->
	<select id="selectAttmBoardList" resultType="Attachment">
		select *
		from attachment
		where attm_status='Y'
		<if test="bId != null">
			and attm_ref_type = 'B'
		</if>
		order by attm_id
	</select>
	
	<select id="selectBoard" parameterType="board" resultMap="BoardResult">
		select *
		from board
			join member using (mb_id)
		where b_status = 'Y' and b_no = #{ bNo }
	</select>
	
	<resultMap type="Board" id="BoardResult">
	    <result column="b_content" property="bContent" jdbcType="CLOB" javaType="java.lang.String"/>
	</resultMap>
	
	<insert id="insertBoard" useGeneratedKeys="true">
		<selectKey order="BEFORE" resultType="_int"	keyProperty="bNo">
			select seq_b_No.nextval from dual 
		</selectKey>

		insert into board
		values (#{bNo}, #{bTitle}, #{bContent}, default, SYSDATE, default, #{mbId}, #{mbNickName})
	</insert>
	
	
	<!-- 실종게시판 -->
	
	<!-- 검색 기능 -->
	<select id="searchLostBoards" parameterType="map" resultType="LostBoard">
	    SELECT *
	    FROM Missing_Board
	      JOIN Member using(mb_id)
	    WHERE m_status = 'Y'
	    <choose>
	        <when test="searchType == 'mn'">
	            AND m_title LIKE '%' || #{searchKeyword} || '%' or mb_nickName LIKE '%' || #{searchKeyword} || '%'
	        </when>
	        <when test="searchType != null">
	            AND ${searchType} LIKE '%' || #{searchKeyword} || '%'
	        </when>
	    </choose>
	    ORDER BY m_no DESC
	</select>
	
	<!--삭제되지 않은 게시글 목록의 개수 조회-->
	<select id="mListCount" resultType="_int">
	    select count(*)
	    from Missing_Board
	    where m_status = 'Y'
	</select>
	
	<!-- 게시글 목록 조회 -->
	<select id="selectLostBoardList" resultType="LostBoard">
	    select *
	    from Missing_Board 
	    join Member using( mb_id )
	    where m_status = 'Y' 
	    order by m_no desc
	</select>
	
	<!-- 게시글에 첨부된 파일 목록 조회 -->
	<select id="selectAttmLostBoardList" resultType="com.kh.woofly.board.model.vo.Attachment">
	    select * from (
		select 
		  ROW_NUMBER() OVER(PARTITION BY attm_Ref_No ORDER BY attm_id ASC) AS RNUM , m.*
		from attachment m
		where attm_status='Y'
		and attm_ref_type = 'M' 
		<if test="bId != null">
	        and attm_ref_no = #{bId}
	    </if>
		) A
		WHERE 1=1
		<if test="bId == null">
		AND RNUM = 1
		   </if>
		order by attm_id DESC
	</select>
	    
	    <!--select *
	    from attachment
	    where attm_status='Y'
	      and attm_ref_type = 'M'
	    <if test="bId != null">
	        and attm_ref_no = #{bId}
	    </if>
	    <if test="bId == null">
	        and 1=2
	    </if>
	    order by attm_id-->
	
	<insert id="insertLostBoard">
       <selectKey keyProperty="mNo" order="BEFORE" resultType="_int"> 
           select ms_no_seq.nextval as mNo from dual
       </selectKey>
       insert into missing_board 
       values (#{mNo}, #{mTitle}, #{mContent},default, SYSDATE, default, #{mbId})
   </insert>

	<!--첨부파일 등록-->
	<insert id="insertLostAttm">
      insert all
      <foreach collection="list" item="item">
         into attachment
         values(new_aid, #{item.originalName}, #{item.renameName},
         SYSDATE, SYSDATE, #{item.attmPath}, default, 'M', #{item.attmRefNo}, #{item.attmLevel})
      </foreach>
      select * from dual
   </insert>
	
	<!-- 특정 게시글 조회 -->
	<select id="selectLostBoard" parameterType="int" resultMap="LostBoardWithAttachmentsMap">
	    select mb.*, m.mb_nickName
	    from Missing_Board mb
	    join Member m on mb.mb_id = m.mb_id
	    where mb.m_status = 'Y' and mb.m_no = #{mNo}
	</select>
	
	<!-- 게시글과 첨부파일 매핑 -->
	<resultMap id="LostBoardWithAttachmentsMap" type="com.kh.woofly.board.model.vo.LostBoard">
	    <id column="m_no" property="mNo"/>
	    <result column="m_title" property="mTitle"/>
	    <result column="m_content" property="mContent"/>
	    <result column="m_count" property="mCount"/>
	    <result column="m_create_date" property="mCreateDate"/>
	    <result column="m_status" property="mStatus"/>
	    <result column="mb_id" property="mbId"/>
	    <result column="mb_nickName" property="mbNickName"/>
	    <collection property="attachments" ofType="com.kh.woofly.board.model.vo.Attachment" 
	                select="selectAttmLostBoardList" column="m_no" javaType="list"/>
	</resultMap>
	
	
	
	
	
	
</mapper>
