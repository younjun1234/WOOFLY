<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>petPhoto</title>
<link rel="icon" href="/image/woofly.png">
<style>
   .active {
      color: black !important;
      font-weight: 700 !important;
   }
</style>
</head>
<body>
   <!-- top navigation bar -->
   <!-- 마이 페이지에 공통으로 들어가는 navigation bar -->
   <div th:replace="~{common/top :: top}"></div>
   <!-- 메인 네비게이션 바 아래 있는 모든 요소들 -->
   <main>
      <div class="d-flex justify-content-between mx-5">
         <div th:replace="~{common/myNav :: myNav}"></div>
         <!-- 아래만 수정해주세요 -->
         <!-- 아래만 수정해주세요 -->
         <!-- 아래만 수정해주세요 -->
         <!-- 아래만 수정해주세요 -->
         <!-- 아래만 수정해주세요 -->
         <!-- 아래만 수정해주세요 -->
         
         <!-- 무한 스크롤 예정 -->
         
      <div class="col-10">
         <div class="border-bottom border-3 border-black">
            <h3>마이펫 사진첩</h3>
            <br>
         </div>
         <div class="d-flex justify-content-end">
             <a href="/pet/petPhotoWrite" class="btn btn-dark btn-sm mt-3 mb-2">글쓰기</a>
         </div>
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-7">
                        <div class="ms-auto d-block">
                        <div class="d-flex align-items-center mb-1" >
                          <div class="p-2">
                               <img th:each="p : ${pList}" th:src="'/image/' + ${p.petProfile}" style="width: 50px; height: 50px; border-radius: 100px; border: 1px grey">
                          </div>
                          <div class="p-2">
                          <strong th:each="p : ${pList}" th:text="${p.petName}"></strong>
                          </div>
                          <div class="p-2 ms-auto">
                              <!-- <div class="btn-group">
                                 <svg role="button" data-bs-toggle="dropdown" aria-expanded="false" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-three-dots dropdown-toggle" viewBox="0 0 16 16">
                                   <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                 </svg>
                                   <ul class="dropdown-menu">
                                      <li><a class="dropdown-item" href="#">수정</a></li>
                                      <li><a class="dropdown-item" href="#">삭제</a></li>
                                   </ul>
                              </div> -->
                              <input type="hidden" name="abNo" value="abNo">
                              <a th:href="'/pet/petPhotoEdit/' + ${abNo}" class="btn btn-outline-dark btn-sm">수정</a>
                              <a role="button" class="btn btn-sm btn-dark" id="deletePhotoBtn">삭제</a>
							       <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
									<div class="modal-dialog modal-dialog-centered" role="document">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title" id="exampleModalLabel">마이펫 사진첩 삭제</h5>
											</div>
											<div class="modal-body">
												<strong>마이펫 사진첩을 정말로 삭제하시겠습니까?</strong>
								        		<p>(삭제된 사진첩은 복구되지 않습니다.)</p>
											</div>
											<div class="modal-footer justify-content-between">
										        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">아니오</button>
										        <a th:href="'/pet/petPhotoDelete/' + ${abNo}" class="btn btn-dark">네</a>
									      	</div>
										</div>
									</div>
								</div>
                          </div>
                        </div>
                     </div>
            		<!-- 메인 사진 -->
                    <div>
                    	<div id="carouselExampleIndicators" class="carousel slide" data-bs-interval="false">
                          <div class="carousel-inner rounded mx-auto d-block" style=" height: 500px;">
                            <div class="carousel-item" th:each="a, aStat :${aList}" th:classappend="${aStat.index == 0} ? 'active'">
                              <img th:src="|/image/${a.renameName}|" class="d-block h-100 w-100" alt="...">
                            </div>
                          </div>
                          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                          </button>
                          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                          </button>
                        </div>
                     </div> 
                     
                     <div class="d-flex mt-1 border-bottom">
                       <div class="me-auto p-2">
                          <svg role="button" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                             <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                        </svg>
                        <strong>1004</strong>
                       </div>
                       <div class="p-2">
                          <p th:if="${aList.size() > 0}" th:text="${aList[0].abDate}"></p>
                       </div>
                     </div>
                     <div class="d-flex mt-2 mb-2">
                        <p class=" mb-1">
                        <p th:if="${aList.size() > 0}" th:text="${aList[0].abContent}"></p>
                     </div>
                     
                     <!-- 댓글 조회 -->
                     	<input type="hidden" id="abNo" name="abNo" th:value="${aList[0].abNo}">
						<input type="hidden" id="mbId" name="mbId" th:value="${session.loginUser?.mbId}">
						<input type="hidden" id="mbNickname" name="mbNickname" th:value="${session.loginUser?.mbNickName}">
						
						<div id="replybody">				
		                     <div class="d-flex mt-3 border-bottom">
		                        <strong>댓글 [[${#arrays.length(rList)}]]개</strong>
		                        <p role="button">&nbsp;&nbsp;모두 보기</p>
		                     </div>
		                     
		                     <div class="ms-auto d-block">
			                        <div class="d-flex align-items-center" th:each="r : ${rList}">
			                          <div class="p-2">
			                               <img th:src="'/image/' + ${r.mbPhoto}" style="width: 50px; height: 50px; border-radius: 100px; border: 1px grey">
			                          </div>
			                          <div class="d-flex align-items-center p-2 col-9">
			                       	   	  <p class="col-3" th:text="${r.mbNickName}"></p>
			                        	  <input th:id="${r.rNo}+'content'" type="text" class="form-control-plaintext col-9 text-secondary" th:value="${ r.reContent }" readonly>
			                          </div>
			                          <div class="p-2 ms-auto d-flex align-items-center">
			                             <svg role="button" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
			                                <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
			                             </svg>
			                             <div class="dropdown mt-1">
						                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-three-dots-vertical dropdown-toggle" data-bs-toggle="dropdown" role="button" viewBox="0 0 16 16">
						                          <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
						                    </svg>
						                    <ul class="dropdown-menu">
					                        	<input type="hidden" th:value="${r.rNo}">
						                        <li>
						                        	<button class="dropdown-item editReplyBtn">수정</button>
						                        </li>
						                        <li><button class="dropdown-item deleteReplyBtn">삭제</button></li>
						                        <li><button class="dropdown-item">신고</button></li>
						                    </ul> 
						                </div>
			                          </div>
			                       </div>
		                       </div>
	                       </div>
                         <!-- 댓글 입력창 -->
                          <div class="mt-3 mb-5" th:if="${ session.loginUser != null}" >
							<div class="row justify-content-center d-flex">
								<div class="col-10">
									<input class="form-control" id="replyContent" type="text" placeholder="댓글 달기...">
								</div>
								<div class="col-auto">
									<button type="button" class="btn btn-sm btn-dark" id="replySubmit" style="width:70px;">댓글</button>
								</div>
							</div>
						</div>
                    </div>
                </div>
            </div>
         </div>
      </div>
   </main>
   <script>
      const myNav = document.getElementById("myPet2");
      $(myNav).removeClass('text-secondary');
      $(myNav).addClass('active');
      
      //댓글 수정 ajax
      const editReplyBtns = document.getElementsByClassName('editReplyBtn');
      
      for(const editReplyBtn of editReplyBtns) {
    	const rNo = editReplyBtn.parentElement.parentElement.firstElementChild.value;
    	const replyContent = document.getElementById(rNo+'content');
    	
    	editReplyBtn.addEventListener('click', ()=>{
	    	$(replyContent).attr('readonly', false);
	    	$(replyContent).removeClass('form-control-plaintext');
    	});
    	
    	replyContent.addEventListener('keyup', (event)=>{
    		if(event.key === 'Enter'){
				$.ajax({
					url : "/updateReply.dw",
					data : {rNo:rNo, reContent:replyContent.value},
					success: (data) =>{
		   		 		 if(data == 'good'){
								$("#replybody").load(location.href + " #replybody" );
								document.getElementById('replyContent').value = '';
								console.log(data);
						} else {
							console.log(data);
						}
    		 	    },
					error : (data) => console.log(data)
				})    		  
      	  }
    	})
    	
      }
      
      //댓글 삭제 ajax
      const deleteReplyBtns = document.getElementsByClassName('deleteReplyBtn');
      
      for(const deleteReplyBtn of deleteReplyBtns) {
    	const rNo = deleteReplyBtn.parentElement.parentElement.firstElementChild.value;
    	
    	console.log(rNo);
    	
    	deleteReplyBtn.addEventListener('click', ()=>{
			$.ajax({
				url : "/deleteReply.dw",
				data : {rNo:rNo},
				success: (data) =>{
	   		 		 if(data == 'good'){
						$("#replybody").load(window.location.href + " #replybody" );
						console.log(data);
					} else {
						console.log(data);
					}
   		 	    },
				error : (data) => console.log(data)
			})    		  
    	})
    	
      }
      
      /* //사진이 한 장인 경우 버튼 숨기기
      document.addEventListener('DOMContentLoaded', function () {
          var carousel = new bootstrap.Carousel(document.getElementById('carouselExampleIndicators'), {
              interval: false
          });

          if (document.querySelectorAll('#carouselExampleIndicators .carousel-item').length <= 1) {
              document.querySelector('.carousel-control-prev').style.display = 'none';
              document.querySelector('.carousel-control-next').style.display = 'none';
          }
      }); */
      
      //마이펫 사진첩 삭제 모달	
	  $('#deletePhotoBtn').click(function(e){
	      e.preventDefault();
		  $('#deleteModal').modal("show");
	  });
      
      document.getElementById('replyContent').addEventListener('keyup', (event)=>{
    	  if(event.key === 'Enter'){
    		  document.getElementById('replySubmit').click();
    	  }
      });
      
      //댓글 ajax
      document.getElementById('replySubmit').addEventListener('click', ()=>{
    	  
    	  const abNo = Number(document.getElementById('abNo').value);
    	  const mbId = document.getElementById('mbId').value;
    	  const mbNickNmae = document.getElementById('mbNickname').value;
    	  const replyContent = document.getElementById('replyContent').value;
    	  
    	  if(replyContent !== '') {
    		  console.log(replyContent);
    		  $.ajax({
    			  url: '/insertReply.dw',
    			  data: {reContent:replyContent, bNo:abNo},
    		 	  success: (data) =>{
	   		 		 if(data == 'good'){
							$("#replybody").load(location.href + " #replybody" );
							document.getElementById('replyContent').value = '';
							console.log(data);
					} else {
						console.log(data);
					}
    		 	  },
    		 	  error: data => console.log(data)
    		  });
    	  }
      })
      
      
      
    
   </script>
</body>
</html>