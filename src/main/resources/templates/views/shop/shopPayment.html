<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
	crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 토스 페이먼츠 -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        textarea{
            width: 100%;
            max-width: 100%;
            height: 150px;
        }
        
        .continue {
            text-decoration-line: none;
        }
    </style>

</head>
<body>
    <!-- tap -->
    <nav class="navbar sticky-top bg-white">
		<div class="container-fluid justify-content-end mx-5">
			<ul class="nav bg-white">
				<li class="nav-item"><a class="nav-link text-black" href="#"><small>고객센터</small></a></li>
				<li class="nav-item"><a class="nav-link text-black" href="#"><small>마이페이지</small></a></li>
				<li class="nav-item"><a class="nav-link text-black" href="#"><small>관심</small></a></li>
				<li class="nav-item"><a class="nav-link text-black" href="#"><small>알림</small></a></li>
				<li class="nav-item"><a class="nav-link text-black" href="#"><small>로그인</small></a></li>
			</ul>
		</div>
		<div class="container-fluid mx-5">
    		<a class="navbar-brand" href="#"><img src="resources/image/woofly.png" alt="Woofly" width="100" height="60"></a>
    		<ul class="nav">
    			<li class="nav-item"><a class="nav-link text-black" href="#">HOME</a></li>
    			<li class="nav-item"><a class="nav-link text-black" href="#">SHOP</a></li>
    			<li class="nav-item"><a class="nav-link text-black" href="#">MAP</a></li>
    		</ul>
		</div>
	</nav>
    <main>
        <div class="container mt-5">
            <h1 class="fw-bold mb-4 border-2 border-bottom border-black pb-2">결제페이지</h1>
            <div class="row">
                <div class="col-md-8 bg-white p-4">
                    <div class="d-flex justify-content-between border-bottom pb-2">
                        <h1 class="fw-bold">장바구니</h1>
                        <h2 class="fw-bold">3 Items</h2>
                    </div>
                    <div class="d-flex mt-4 mb-3">
                        <div class="w-10 p-2">
                            <input type="checkbox" class="product-checkboxes">
                        </div>
                        <div class="w-50">
                            <h3 class="fw-bold text-center">상품 설명</h3>
                        </div>
                        <div class="w-20 text-end">
                            <h3 class="fw-bold text-center">상품 수량</h3>
                        </div>
                        <div class="w-25 text-end">
                            <h3 class="fw-bold text-center">가격</h3>
                        </div>
                    </div>
                    <!-- Sample Product 1 -->
                    <div class="productDiv d-flex align-items-center border-bottom py-3">
                        <div class="w-10 p-2">
                            <input type="checkbox" class="product-checkbox">
                        </div>
                        <div class="w-50 d-flex">
                            <img class="mr-3" src="https://unsplash.com/photos/2TQwrtZnl08/download?force=true&w=640" alt="product image" width="80">
                            <div class="mx-3">
                                <span class="fw-bold">Iphone 11 Pro</span><br>
                                <span class="text-danger">Apple</span><br>
                                <a href="#" class="fw-bold text-muted small">Remove</a>
                            </div>
                        </div>
                        <div class="w-20 text-center">
                            <input class="form-control mx-auto w-50" type="number" value="1" min="1">
                        </div>
                        <div class="w-20 text-center fw-bold">900.000원</div>
                    </div>
                    <!-- Sample Product 2 -->
                    <div class="productDiv d-flex align-items-center border-bottom py-3">
                        <div class="w-10 p-2">
                            <input type="checkbox" class="product-checkbox">
                        </div>
                        <div class="w-50 d-flex">
                            <img class="mr-3" src="https://unsplash.com/photos/3Tf1J8q9bBA/download?force=true&w=640" alt="product image" width="80">
                            <div class="mx-3">
                                <span class="fw-bold">Macbook Pro</span><br>
                                <span class="text-danger">Apple</span><br>
                                <a href="#" class="fw-bold text-muted small">Remove</a>
                            </div>
                        </div>
                        <div class="w-20 text-center">
                            <input class="form-control mx-auto w-50" type="number" value="1" min="1">
                        </div>
                        <div class="w-20 text-center fw-bold">1,800,000원</div>
                    </div>
                    <a href="#" class="fw-bold text-primary mt-4 d-flex align-items-center continue">
                        <span class="mr-2">쇼핑 계속하기</span>
                        <svg width="20" height="20" viewBox="0 0 448 512">
                            <path d="M134.059 296H24c-13.255 0-24-10.745-24-24V24C0 10.745 10.745 0 24 0h362.059c13.255 0 24 10.745 24 24v248c0 13.255-10.745 24-24 24H313.941L134.059 296zM313.941 216H134.059L77.088 272h293.824l-57.971-56z" fill="#1e40af"></path>
                        </svg>
                    </a>
                </div>
    
                <!-- 자바스크립트로 계산식 -->
                <!-- 
                    체크 될 때마다 textarea에 상품 제목 + 수량
                    input type="hidden" name="상품번호" value="상품번호"
                    input type="hidden" name="상품번호" value="상품번호"
                    input type="hidden" name="상품번호" value="상품번호"

                    input type="hidden" name="상품가격" value="상품가격"
                    input type="hidden" name="상품가격" value="상품가격"
                    input type="hidden" name="상품가격" value="상품가격"

                    해당 상품의.. 수량은 어떻게..?
                    
                -->
                
                <div class="col-md-4 p-4">
                    <form class="form" method="POST">
                        <h1 class="fw-bold border-bottom pb-2">주문 상세</h1>
                        <div class="d-flex justify-content-between mt-4 mb-3">
                            <span class="fw-bold">Items 3</span>
                            <span>2,700.000원</span>
                        </div>
                        <div class="flex-column flex-column">
                            <label class="mb-2 fw-bold">구매희망목록</label>
                            <textarea class="text-bg-light text-success-emphasis overflow-auto" style="resize:none;" readonly></textarea>
                        </div>
                        <div class="py-4">
                            <lable for="hasPoint" class="fw-bold mb-2">현재 보유 포인트</lable>
                            <input type="text" class="form-control mb-2" id="hasPoint" value="50000P" readonly>
                            <label for="point" class="fw-bold mb-2">포인트 사용</label>
                            <input type="text" id="point" placeholder="사용할 포인트 입력" class="form-control">
                        </div> 
                        <div class="border-top pt-4">
                            <div class="d-flex justify-content-between fw-bold py-3">
                                <span>구매 총합</span>
                                <span>2,700,000원</span>
                            </div>
                            <div class="hidden-inputs"></div>
                            <div class="total-amount"></div>
                            <div class="button-group text-end">
                                <button type="button" class="btn btn-outline-danger btn-block fw-bold mb-4 mx-2" id="payment">결제</button>
                                <button type="reset" class="btn btn-outline-primary btn-block fw-bold mb-4">비우기</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 카드등록키값 유무 따져서 사용해야 함 -->
        <input type="hidden" name="billingKey" value="123" id="billingKey">
        <input type="hidden" name="userId" value="user01" id="customerKey">
    </main>

    <script>

        const payBtn = document.getElementById('payment');
        const billingKey = document.getElementById('billingKey').value;
        const customerKey = document.getElementById('customerKey');

        // 테스트 모드 어케하냐..
        payBtn.addEventListener('click', () => {
            if(billingKey == '') {
                tossPayment();
            } else {
                tossPayment();
                console.log("결제 카드 있음!");
            }
        });

        // 카드 등록 (billingKey 필요함.)
        // test모드에서 인증번호 : 000000
        function tossPayment () {
            
            var clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq'
            var tossPayments = TossPayments(clientKey)
    
            tossPayments
            .requestBillingAuth('카드', {
                // 결제수단 파라미터 (자동결제는 카드만 지원합니다.)
                // 결제 정보 파라미터
                customerKey: customerKey, // 고객 ID로 상점에서 만들어야 합니다. 빌링키와 매핑됩니다. 자세한 파라미터 설명은 파라미터 설명을 참고하세요: https://docs.tosspayments.com/reference/js-sdk#결제-정보-5
                successUrl: 'http://localhost:8080/payment.sp', // 카드 등록에 성공하면 이동하는 페이지(직접 만들어주세요)
                failUrl: 'https://my-store.com/fail', // 카드 등록에 실패하면 이동하는 페이지(직접 만들어주세요)
            })
            .catch(function (error) {
                if (error.code === 'USER_CANCEL') {
                // 결제 고객이 결제창을 닫았을 때 에러 처리
                }
            })
        }

        // 자동 결제 API 등록


        $(document).ready(function() {
            $('.product-checkbox').on('change', function() {
                const productName = $(this).parent().siblings().find('.fw-bold').first().text().trim();
                const productQuantity = $(this).parent().siblings().find('input[type="number"]').val();
                const productPrice = $(this).parent().siblings().find('.fw-bold').last().text().trim().replace(/,/g, '').replace('원', '');

                const productDetail = `${productName} - 수량: ${productQuantity} - 가격: ${productPrice}원\n`;

                if ($(this).is(':checked')) {
                    // textarea에 상품 정보 추가
                    const currentVal = $('textarea').val();
                    $('textarea').val(currentVal + productDetail);
                } else {
                    // 체크박스가 체크 해제되면 해당 상품 정보를 textarea에서 제거
                    const currentVal = $('textarea').val();
                    $('textarea').val(currentVal.replace(productDetail, ''));
                }
            });
        });

        $(document).ready(function() {
            // product-checkboxes 체크박스 이벤트 리스너 추가
            $('.product-checkboxes').on('change', function() {
                const isChecked = $(this).prop('checked');
                
                // 모든 product-checkbox 체크박스의 상태를 product-checkboxes의 상태로 설정
                $('.product-checkbox').prop('checked', isChecked);
                
                // textarea 업데이트
                updateTextareaAndHiddenInputs();
            });

            // product-checkbox 체크박스 이벤트 리스너 추가
            $('.product-checkbox').on('change', function() {
                updateTextareaAndHiddenInputs();
            });

            function updateTextareaAndHiddenInputs() {
                let totalAmount = 0;
                let textareaValue = "";
                let hiddenInputs = "";
                
                $('.product-checkbox:checked').each(function() {
                    const $parentDiv = $(this).closest('.productDiv');
                    const productName = $parentDiv.find('.fw-bold').first().text();
                    const productQuantity = parseInt($parentDiv.find('input[type="number"]').val(), 10);
                    const productPrice = parseInt($parentDiv.find('.fw-bold').last().text().replace(/,/g, ''), 10); // 가격에서 쉼표 제거

                    const totalPrice = productQuantity * productPrice;
                    totalAmount += totalPrice;
                                                        // - 가격: ${productPrice.toLocaleString()}원
                    textareaValue += `${productName} - 수량: ${productQuantity}  - 총액: ${totalPrice.toLocaleString()}원\n`;
                    hiddenInputs += `<input type="hidden" name="product_${productName}" value="상품번호: ${productName}, 가격: ${productPrice}, 수량: ${productQuantity}">`;
                });
                
                $('textarea').val(textareaValue);
                $('.total-amount').text(`총 금액: ${totalAmount.toLocaleString()}원`);
                $('.hidden-inputs').html(hiddenInputs);
            }
        });





    </script>
</body>
</html>
